<!DOCTYPE html>
<html>
<head>
<meta charset ="utf-8">
<title>Javapoli</title>
<style type="text/css">
ul {
	list-style-type: none;
}
ul li {
	background-color: #333;
	padding: 6px;
	margin-bottom: 2px;
	width: 90%;
	border: 1px solid lightgreen;
	-webkit-border-radius: 5px;
	border-radius: 5px;
}
</style>
</head>
<body id="body"style="text-align: center; font-size: 12px; background-color: #333; color: lightgreen; font-family: 'Lucida Console', Monaco, monospace">
<div style="display: block; width: 600px; height: 600px; margin-left: auto; margin-right: auto; ">
<ul id="gametext" style="width: 100%; height: 50%; overflow: auto; text-align: left; border: 1px solid black;  background-color: #101010; ">

</ul>
<br/>
your command:
<input type="text" id="cmd" style="width: 400px; color: green; font-family: 'Lucida Console', Monaco, monospace; background-color: #000000; border:none;">
</div>
<script type="text/javascript">
var Javapoli = (function(){
var q = {},
	currentCallback = "initPlayerNum",
	can_move = true,
	oldT = 10000,
	game = {};
	game.fields = [
		{name: "Start field", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: null, group_factor: 2},
		{name: "Donau Street", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 1, group_factor: 2},
		{name: "Rhine Street", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8.000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 1, group_factor: 2},
		{name: "Urban Market", price: 4000, callback: "_streetFieldLanding", player: null, credit: 9000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 2, group_factor: 2},
		{name: "Tree Alley", price: 4000, callback: "_streetFieldLanding", player: null, credi: 9000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 2, group_factor: 2},
		{name: "Airport North", price: 4000, callback: "_streetFieldLanding", player: null, credit: 9000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 2, group_factor: 2},
		{name: "Ford Plaza", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 3, group_factor: 2},
		{name: "Eastern Pathway", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 3, group_factor: 2},
		{name: "Millenium Drive", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 4, group_factor: 2},
		{name: "Park Alley", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 4, group_factor: 2},
		{name: "Seven Oaks", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 5, group_factor: 2},
		{name: "Castle Road", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 5, group_factor: 2},
		{name: "Mountain View", price: 4000, callback: "_streetFieldLanding", player: null, credit: 8000, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain", group: 5, group_factor: 2}
		],
	game.html = "",
	game.players = [],
	game.dmoney = 150000,
	game.currentPlayer = 0,
	allowed_funcs = ["step", "go", "exit", "buy", "sell", "money", "streets", "credit", "commands"],
	game.funcDesc = {
		step: 		"step lets you roll the dice and advance the respecive street fields.",
		go:			"go is an alias for step.",
		exit: 		"exit starts a new game",
		buy:		"buy:street,vendor,price  lets you buy a street of another player.",
		sell:		"sell:street,buyer,price  lets you sell a street to another player",
		money:		"money shows the respective earned or remaining game currency of each player",
		streets:	"streets:own  lets you see street posessions of each player (no : plus parameter) or your own (: plus own)",
		credit:		"credit:street lets you turn the chosen street into money. You cannot get paid for landings on this street though while credited."
	};
	q.initPlayerNum = function(input) {
		if(	isNaN(parseInt(input)) ) {
			return this.updateHtml( "<li>"+input + "</li><li>Please type an integer number...!</li>" );
		}
		for(var i = 0; i < input; i++) {
			this.addPlayer();		
		}
		currentCallback = "setPlayerNames";
		return this.updateHtml( input + "<li>Please add the Player Names ("+input+" names), comma-separated.</li>" );
	},
	q.commands = function() {
		for (var key in game.funcDesc) {
			this.updateHtml("<li>"+game.funcDesc[key]+"</li>");
		}
		this.checkIfMore();
	},
	q.credit = function(arguments) {
		var street;
		if( arguments.length ) {
			street = arguments[0];
			if(isNaN(parseInt(street))) {
				street = this.getStreetIndexFromName(street);
				if(street === false) return this.updateHtml("<li>The street does not exists, please try again!</li>");
			}		
			if(street < 0 || street > game.fields.length -1) return this.updateHtml("<li>The street index you typed is not existing</li>");
			if(game.fields[street].player != game.currentPlayer) return this.updateHtml("<li>You do not own this street... no credit on it. Ty another!</li>");
			if(game.fields[street].status == "credit") return this.updateHtml("<li>The street is already credited. Please choose another!</li>");
			game.players[game.currentPlayer].money += game.fields[street].credit;
			game.fields[street].status = "credit";
			this.updateHtml("<li>The bank has provided you "+game.fields[street].credit+"€ for "+game.fields[street].name+"</li>");
			this.checkIfMore();
		} else {
			this.updateHtml("<li>Please use the credit function with the syntax credit:[street], where street is either the name or index of the field you want to turn into credit.</li>")
		}
	},
	q.sell = function(arguments) {
		var street, buyer, price, street_validated = true, buyer_validated = true, price_validated = true, errors = [];
		if ( arguments.length > 0 ) {
			var street = arguments[0];
		}
		if (arguments.length >= 1) {
			buyer = arguments[1];
		}
		if (arguments.length >= 2) {
			price = arguments[2];
		}
		if(street === undefined || buyer === undefined || price === undefined)
		return this.updateHtml("<li>Please check if you typed sell:[street][buyer][price] with street and buyer as their indizes or names as the command can't be properly parsed.</li>");
		
		if(isNaN(parseInt(price))) {
			errors.push("The price must be a positive integer number.");
			price_validated = false;
		} else {
			price = parseInt(price);
			if(price < 1) {
				errors.push("The price must be > 0");
				price_validated = false;
			}
		}
		
		if(isNaN(parseInt(street))) {
			street = this.getStreetIndexFromName(street);
			if(street === false) errors.push("The street does not exists, please check your input!");
			street_validated = false;
		} else {
			street = parseInt(street);
			if(street < 0 || street > game.fields.length - 1) {
				errors.push("The street index you typed is not exisiting.");
				street_validated = false;
			}
		}
		
		if ( street_validated && game.fields[street].player != game.currentPlayer ) {
			errors.push("You don't own this field.");
		}
		
		if(isNaN(parseInt(buyer))) {
			buyer = this.getPlayerIndexFromName(buyer);
			if(buyer === false) errors.push("The buyer does not exist, please check your input!");
			buyer_validated = false;
		} else {
			buyer = parseInt(buyer);
			if(buyer < 0 || buyer > game.players.length - 1) {
				buyer_validated = false;
				errors.push("The buyer index you typed does not exists.");
			}
		}
		if ( buyer_validated && game.players[buyer] == game.players[game.currentPlayer] ) {
			errors.push("You can't sell to your own.");
		}
		
		if(errors.length)  {
			this.updateHtml("<li>Cannot meaningfully parse your input:</li>");
			this.updateHtml("<li>"+errors.join(',')+"</li>");
		 } else {
			if( confirm(game.players[buyer].name + ", do you really want to buy "+game.fields[street].name+" for " +price+"?"))
			{
				game.players[buyer].money -= price;
				game.players[game.currentPlayer].money += price;
				game.fields[street].player = buyer;
				if (this.checkMoney(buyer)) {
					this.updateHtml("<li>Sold! "+game.players[buyer].name+" has €"+game.players[buyer].money+" left"
					+" and "+game.players[game.currentPlayer].name+" has €"+game.players[game.currentPlayer].money+" left.</li>");
					this.checkIfMore();
				}
			} else {
				this.updateHtml("<li>OK - not sold.</li>");
				this.checkIfMore();
			}					
		 }
	},
	q.getStreetIndexFromName = function(name) {
		var exists = false;
		for (var k = 0; k < game.fields.length; k++) {
			if(game.fields[k].name == name) {
				exists = true;
				break;
			}
		}
		if(exists) return k;
		return false;
	},
	q.getPlayerIndexFromName = function(name) {
		var exists = false;
		for (var k = 0; k < game.players.length; k++) {
			if(game.players[k].name == name) {
				exists = true;
				break;
			}
		}
		if(exists) return k;
		return false;
	},
	q.setPlayerNames = function(names) {
		var sep_names = names.split(",");
		if ( sep_names.length != game.players.length) {
			this.updateHtml("You need " + game.players.length + " Names, but provided " + sep_names.length + "!");
		} else {
			for(var i = 0; i < sep_names.length; i++) {
				this.setPlayerName(i, sep_names[i]);
			}
			currentCallback = "parseCommand";
			this.step();
		}
	},
	q.step = function(){
		if(can_move) {
			var eyes = this.rollDice();
			console.log("Current Player:" + game.currentPlayer);
			this.updateHtml("<li> player "+ game.players[game.currentPlayer].name + " advances " + eyes + " fields</li>");
			var pos = game.players[game.currentPlayer].position + eyes;
			if (pos > game.fields.length - 1){
				pos = pos - game.fields.length;		
				if (pos > 0) {
					game.players[game.currentPlayer].money += 2000000;
					this.updateHtml("<li>you just earned 2000000 € due to passing the start field.</li>")
				}
			}
			if(pos === 0) {
				game.players[game.currentPlayer].money += 4000000;
				this.updateHtml("<li>you just earned 4000000 € due to landing on the start field.</li>")
			}
			this.updateHtml("<li> he lands on "+game.fields[pos].name);
			game.players[game.currentPlayer].position = pos;
			var callback = game.fields[pos].callback;
			this[callback]();
		} else {
			this.updateHtml("<li>You are not allowed to move twice...</li>");
			this.checkIfMore();
		}
	},
	q.addPlayer = function() {
		game.players.push({ name: "default", money: game.dmoney, position: 0 });
	},
	q.money = function() {
		for(var i = 0 ; i < game.players.length ; i++){
			this.updateHtml("<li>"+game.players[i].name+" has "+game.players[i].money+" € </li>");
		};
		this.checkIfMore();
	},
	q.go = function() {
		this.step()
	},
	q.streets = function() {		
		if(arguments.length && arguments[0] == "own") {
			var str_eets = [], owns = false;
			for (var k = 0; k < game.fields.length; k++) {
				if(game.fields[k].player == game.currentPlayer) {
					owns = true;
					str_eets.push( game.fields[k].name + " ("+k+" - "+game.fields[k].status+")");
				}
			}
		this.updateHtml("<li>You own: " + ( owns ? str_eets.join(" + ") : " nothing" ) + "</li>")			
		} else {
			for(var i = 0; i < game.players.length; i++) {
			var str_eets = [], owns = false;
				for(var k = 0; k < game.fields.length; k++) {
					if(game.fields[k].player == i) {
						owns = true;
						str_eets.push( game.fields[k].name + " ("+k+" "+game.fields[k].status+")" );
					}
				}
			this.updateHtml("<li>" + game.players[i].name + " owns: " + ( owns ? str_eets.join(" + ") : " nothing" ) + "</li>");
			}	
		}			
		this.checkIfMore();
	},
	q.setPlayerName = function(index, name) {
		game.players[index].name = name;
		this.updateHtml("<li>Player "+index+" set to "+name+"</li>");
	},
	q.getNumPlayers = function() {
		return game.players.length;
	},
	q.rollDice = function() {		
		return ( Math.floor(Math.random() * 6) + 1 ) + ( Math.floor(Math.random() * 6) + 1 );
	},
	q.getGroupFactor = function(index) {
		var l = game.fields.length,
			group = game.fields[index].group,
			is_grouped = true,
			ownerIndex = game.fields[index].player;
		for (var i = 0; i < l; i++) {
			if(game.fields[i].group == group) {
				if( game.fields[i].player != ownerIndex ) 				
				{
					is_grouped = false;
					break;
				}							
			}
		}
		if(!is_grouped) return 1;
		return game.fields[index].group_factor;
	},
	q._streetFieldLanding = function() {
		var index = game.players[game.currentPlayer].position;
		var field = game.fields[index];
		// pay rent ? +++++++++++++++++++++++++++++++++++++++++++++++++++
		if (index > 0 && field.player !== null) { // 0 is the start field which can't be purchased
			console.log("currentPlayer: " + game.currentPlayer + " field.player: "+field.player);
			if (game.currentPlayer != field.player) {
				// the currentPlayer has to pay rent to field.player if no hypoteque is on the street
				if (field.status != "credit") {
					var gFactor = this.getGroupFactor(index);
					var rent =  field.rent[field.status] * gFactor;
					this.updateHtml("<li>"+game.players[game.currentPlayer].name +" pays "+game.players[field.player].name +" "+ rent +" €</li>");
					if(gFactor > 1) this.updateHtml("<li>"+game.players[field.player].name+" has all streets of this group, so the rent was raised by the factor "+gFactor+"</li>");
					game.currentPlayer.money -= rent;
					game.players[field.player].money += rent;
					if(this.checkMoney()) {
						this.checkIfMore();
					}
				} else {
					this.updateHtml("<li>The field is currently used for a credit. No fees apply for landing here.</li>");
					this.checkIfMore();
				}
			} else {
				this.checkIfMore();
			}			
		} 
		// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		// buy ? +++++++++++++++++++++++++++++++++++++++++++++++++
		else{
			if(index > 0) {
				currentCallback = "buyStreet";
				this.updateHtml("<li> would you like to buy "+field.name+" for "+field.price+" € ?</li>");
			} else {
				this.checkIfMore();
			}		
		}
		// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		
	},
	q.checkIfMore = function() {
		can_move = false;
		this.updateHtml("<li>Do you want to take more actions?</li>");
		currentCallback = "wantMore";
	},
	q.buyStreet=function(input){
		if(input == "y" || input == "yes"){
			var field = game.fields[ game.players[ game.currentPlayer ].position ];
			game.players[game.currentPlayer].money -= field.price;
			field.player = game.currentPlayer;
			this.updateHtml("<li>Purchased! You have "+game.players[game.currentPlayer].money+" € left </li>");
		} else {
			this.updateHtml("<li>Not purchased!</li>");
		}
		if (this.checkMoney()) {
			this.checkIfMore();
			currentCallback = "wantMore";
		}		
	},
	q.wantMore = function(input) {
		currentCallback = "parseCommand";
		if(input == "n" || input == "no") {
			this.nextPlayer();
			can_move = true;
			this.updateHtml("<li>OK - " + game.players[game.currentPlayer].name + " is now playing his next step!'</li>");
		} else if(this.is_allowed(input.split(":")[0])) {
			can_move = false; // this is a double and can be removed if always using checkIfMore
			this.parseCommand(input);
		} else {
			can_move = false;	// this is a double and can be removed if always using checkIfMore
			this.updateHtml("<li>OK, waiting for your next command!</li>");
		}
	},
	q.checkMoney = function() {
	if(arguments.length) {
		index = arguments[0];
	} else {
		index = game.currentPlayer;
	}	
		if(game.players[index].money < 0) {
			this.updateHtml("<li>"+game.players[index].name+" lost!</li>");			
			currentCallback="restart";
			this.updateHtml("<li> press any key to restart the game </li>");
			return false;
		}
		return true;
	},
	q.restart=function(input){
			location.reload()
	},
	q.nextPlayer = function() {
		
			if(game.currentPlayer < game.players.length - 1) {
				game.currentPlayer ++;
			} else {
				game.currentPlayer = 0;
			}
		
	},
	q.is_allowed = function(cmd) {
		if(allowed_funcs.indexOf(cmd) !== -1) {
			return true;
		} 
		return false;
	},
	q.parseCommand = function(input) {
		if(input != "") {		
			input = input.trim();
			var x = input.split(":");
			var cmd = x[0];
			if(x[1] !== undefined) {
				var arguments = x[1].trim();
				arguments = arguments.split(",");
				console.log(arguments);
			} else {
				var arguments = null;
			}
				if( this.is_allowed(cmd)) {
					this[cmd](arguments);
				} else {
				this.updateHtml("<li>Command does not exist!</li>");
				}
			}	
	},
	q.init = function() {
	var self = this;
		this.updateHtml( "<li>Welcome to Javapoli!<br/>If you get stuck type 'commands' without quotation marks to get instructions.</li><li>How many of you are there?</li>" );
		document.getElementById("body").addEventListener("keypress", function(ev){
			if (ev.keyCode === 13)
			self._parseInput(document.getElementById("cmd").value);
		});
		document.getElementById('cmd').addEventListener("blur", function(ev) {
			ev.preventDefault();
			this.focus();
		});
		document.getElementById('cmd').focus();
	},
	q._parseInput = function(input) {
		// mach was mit dem Input
			if(input != "") {	
			document.getElementById("cmd").value = "";
			input = input.trim();
			this[currentCallback](input);
		}		
	},
	q.scrollIt = function(){
		var self = this;
		var el = document.getElementById('gametext');
		var curT = new Date().getTime();
		var d = curT - oldT;
		var hd = el.scrollHeight - el.offsetHeight, 
		dhd = hd - el.scrollTop; 
			if (dhd > 0) {
				el.scrollTop += 1;
				el.scrollTop += dhd > 150 ? 10 : 0;
				oldT = curT;
				setTimeout(function() { self.scrollIt(); }, 10 - (d < 10 ? d : 0));			
			}		
	},
	q.updateHtml = function(text) {
		game.html += text;
		var el = document.getElementById("gametext");
		el.innerHTML = game.html;
		this.scrollIt();	
	};
return q;
})();
Javapoli.init();
</script>
</body>
</html>
