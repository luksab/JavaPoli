<!DOCTYPE html>
<html>
<head>
<meta charset ="utf-8">
<title>Javapoli</title>
<style type="text/css">
ul {
	list-style-type: none;
}
ul li {
	background-color: #444;
	padding: 5px;
	margin-bottom: 3px;
	width: 90%
}
</style>
</head>
<body id="body"style="text-align: center; font-size: 12px; background-color: #333; color: lightgreen; font-family: 'Lucida Console', Monaco, monospace">
<div style="display: block; width: 600px; height: 600px; margin-left: auto; margin-right: auto; ">
<ul id="gametext" style="width: 100%; height: 50%; overflow: auto; text-align: left; border: 1px solid black;  background-color: #000000; ">

</ul>
<br/>
your command:
<input type="text" id="cmd" style="width: 400px; color: green; font-family: 'Lucida Console', Monaco, monospace; background-color: #000000; border:none;">
</div>
<script type="text/javascript">
var Javapoli = (function(){
var q = {},
	currentCallback = "initPlayerNum",
	can_move = true,
	game = {};
	game.fields = [
		{name: "Start field", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Donau Street", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Rhine Street", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Urban Market", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Tree Alley", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Airport North", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Ford Plaza", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Eastern Pathway", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Millenium Drive", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Park Alley", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Seven Oaks", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Castle Road", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"},
		{name: "Mountain View", price: 4000, callback: "_streetFieldLanding", player: null, rent: {plain: 10000, a1: 50000, a2: 100000, a3: 500000, a4: 1000000, h: 5000000}, status: "plain"}
		],
	game.html = "",
	game.players = [],
	game.dmoney = 150000,
	game.currentPlayer = 0;
	var allowed_funcs = ["step", "go", "exit", "restart", "give up", "buy", "sell", "money", "streets", "mystreets"];
	q.initPlayerNum = function(input) {
		if(	isNaN(parseInt(input)) ) {
			return this.updateHtml( "<li>"+input + "</li><li>Please type an integer number...!</li>" );
		}
		for(var i = 0; i < input; i++) {
			this.addPlayer();		
		}
		currentCallback = "setPlayerNames";
		return this.updateHtml( input + "<li>Please add the Player Names ("+input+" names), comma-separated.</li>" );
	},
	q.setPlayerNames = function(names) {
		var sep_names = names.split(",");
		if ( sep_names.length != game.players.length) {
			this.updateHtml("You need " + game.players.length + " Names, but provided " + sep_names.length + "!");
		} else {
			for(var i = 0; i < sep_names.length; i++) {
				this.setPlayerName(i, sep_names[i]);
			}
			currentCallback = "parseCommand";
			this.step();
		}
	},
	q.step = function(){
		if(can_move) {
			var eyes = this.rollDice();
			console.log("Current Player:" + game.currentPlayer);
			this.updateHtml("<li> player "+ game.players[game.currentPlayer].name + " advances " + eyes + "fields</li>");
			var pos = game.players[game.currentPlayer].position + eyes;
			if (pos > game.fields.length - 1){
				pos = pos - game.fields.length;		
				if (pos > 0) {
					game.players[game.currentPlayer].money += 2000000;
					this.updateHtml("<li>you just earned 2000000 € due to passing the start field.</li>")
				}
			}
			if(pos === 0) {
				game.players[game.currentPlayer].money += 4000000;
				this.updateHtml("<li>you just earned 4000000 € due to landing on the start field.</li>")
			}
			this.updateHtml("<li> he lands on "+game.fields[pos].name);
			game.players[game.currentPlayer].position = pos;
			var callback = game.fields[pos].callback;
			this[callback]();
		} else {
			this.updateHtml("<li>You are not allowed to move twice...</li>");
			this.checkIfMore();
		}
	},
	q.addPlayer = function() {
		game.players.push({ name: "default", money: game.dmoney, position: 0 });
	},
	q.money = function() {
		for(var i = 0 ; i < game.players.length ; i++){
			this.updateHtml("<li>"+game.players[i].name+" has "+game.players[i].money+" € </li>");
		};
		this.checkIfMore();
	},
	q.go = function() {
		this.step()
	},
	q.streets = function() {
		for(var i = 0; i < game.players.length; i++) {
			var str_eets = [], owns = false;
			for(var k = 0; k < game.fields.length; k++) {
				if(game.fields[k].player == i) {
					owns = true;
					str_eets.push( game.fields[k].name );
				}
			}
			this.updateHtml("<li>" + game.players[i].name + " owns: " + ( owns ? str_eets.join(" + ") : " nothing" ) + "</li>")
		}
		this.checkIfMore();
	},
	q.setPlayerName = function(index, name) {
		game.players[index].name = name;
		this.updateHtml("<li>Player "+index+" set to "+name+"</li>");
	},
	q.getNumPlayers = function() {
		return game.players.length;
	},
	q.rollDice = function() {		
		return ( Math.floor(Math.random() * 6) + 1 ) + ( Math.floor(Math.random() * 6) + 1 );
	},
	q._streetFieldLanding = function() {
		var index = game.players[game.currentPlayer].position;
		console.log("currentPlayer position: " + index);
		var field = game.fields[index];
		// Miete +++++++++++++++++++++++++++++++++++++++++++++++++++
		if (index > 0 && field.player !== null) { // 0 is the start field which can't be purchased
			if (game.currentPlayer != field.player) {
				// the currentPlayer has to pay rent to field.player
				var Rent =  field.rent[field.status];
				this.updateHtml("<li>"+game.players[game.currentPlayer].name +" pays "+game.players[field.player].name +" "+ Rent +" €</li>")
				game.currentPlayer.money -= Rent;
				game.players[field.player].money += Rent;				
			}
			if(this.checkMoney()) {
				this.checkIfMore();
			}
		} 
		// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		// Kauf ? +++++++++++++++++++++++++++++++++++++++++++++++++
		else{
			if(index > 0) {
				currentCallback = "buyStreet";
				this.updateHtml("<li> would you like to buy "+field.name+" for "+field.price+" € ?</li>");
			} else {
				this.checkIfMore();
			}		
		}
		// ++++++++++++++++++++++++++++++++++++++++++++++++++++++++
		
	},
	q.checkIfMore = function() {
		this.updateHtml("<li>Do you want to take more actions?</li>");
		currentCallback = "wantMore";
	},
	q.buyStreet=function(input){
		if(input == "y" || input == "yes"){
			var field = game.fields[game.players[game.currentPlayer].position];
			game.players[game.currentPlayer].money -= field.price ;
			field.player = game.currentPlayer;
			this.updateHtml("<li>Purchased! You have "+game.players[game.currentPlayer].money+" € left </li>");
		} else {
			this.updateHtml("<li>Not purchased!</li>");
		}
		if (this.checkMoney()) {
			this.checkIfMore();
			currentCallback = "wantMore";
		}		
	},
	q.wantMore = function(input) {
		currentCallback = "parseCommand";
		if(input == "y" || input == "yes") {
			can_move = false;	
			this.updateHtml("<li>OK, waiting for your next command!</li>");
		} 
		else if(input == "n" || input == "no"){
			can_move = true;
			this.nextPlayer();
			this.updateHtml("<li>OK - " + game.players[game.currentPlayer].name + " is now playing his next step!'</li>");			
		}
		else if (this.is_allowed(input.split(":")[0])){
			can_move=false;
			this.parseCommand(input);
		}
	},
	q.checkMoney = function() {
		if(game.players[game.currentPlayer].money < 0) {
			this.updateHtml("<li>"+game.players[game.currentPlayer].name+" lost!</li>");
			
			currentCallback="restart";
			this.updateHtml("<li> press any key to restart the game </li>");
			return false;
		}
		return true;
	},
	q.restart=function(input){
			location.reload()
	},
	q.nextPlayer = function() {
		
			if(game.currentPlayer < game.players.length - 1) {
				game.currentPlayer ++;
			} else {
				game.currentPlayer = 0;
			}
		
	},
	q.is_allowed = function(cmd) {
		if(allowed_funcs.indexOf(cmd) !== -1) {
			return true;
		} 
		return false;
	},
	q.parseCommand = function(input) {
		if(input != "") {		
			input = input.trim();
			var x = input.split(":");
			var cmd = x[0];
			if(x[1] !== undefined) {
				var arguments = x[1].trim();
			}		
				if( this.is_allowed(cmd)) {
					this[cmd](arguments);
				} else {
				this.updateHtml("<li>Command does not exist!</li>");
				}
			}	
	},
	q.init = function() {
	var self = this;
		this.updateHtml( "<li>Welcome to Javapoli!</li><li>How many of you are there?</li>" );
		document.getElementById("body").addEventListener("keypress", function(ev){
			if (ev.keyCode === 13)
			self._parseInput(document.getElementById("cmd").value);
		});
		document.getElementById('cmd').focus();
	},
	q._parseInput = function(input) {
		// mach was mit dem Input
			if(input != "") {	
			document.getElementById("cmd").value = "";
			input = input.trim();
			this[currentCallback](input);
		}		
	},
	q.updateHtml = function(text) {
		game.html += text;
		var el = document.getElementById("gametext");
		el.innerHTML = game.html;
		el.scrollTop = el.scrollHeight;		
	};
return q;
})();
Javapoli.init();
</script>
</body>
</html>
